<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙˆØµÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù†Ø³Ø®Ø© 10.0 - Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style id="main-app-styles">
        :root {
            --primary-color: #005a9c; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø±Ø³Ù…ÙŠ */
            --secondary-color: #003f6c;
            --success-color: #10b981;
            --danger-color: #dc2626;
            --warning-color: #f59e0b;
            --border-color: #d1d5db;
            --bg-light: #f9fafb;
            --text-dark: #1f2937;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius-md: 0.5rem;
            --transition: all 0.2s ease-in-out;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Tahoma', 'Segoe UI', sans-serif;
            background-color: #f0f4f8;
            color: var(--text-dark);
            line-height: 1.6;
            padding: 10px;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
        }

        h1 { font-size: 1.8rem; color: var(--secondary-color); font-weight: 700; }

        .step {
            background: white;
            border-radius: var(--radius-md);
            padding: 1.2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid var(--border-color);
        }

        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .step-title { font-size: 1.3rem; color: var(--secondary-color); font-weight: 600; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª */
        .file-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-light);
            margin: 1.5rem 0;
            transition: var(--transition);
        }
        .file-upload-container.drag-over {
            border-color: var(--primary-color);
            background: rgba(0, 90, 156, 0.05);
        }
        .file-upload-icon { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem; }
        .file-upload-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem;
            font-size: 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        .file-upload-button:hover { background: var(--secondary-color); }
        .hidden-file-input { display: none; }
        .file-info {
            margin-top: 1rem;
            text-align: center;
            color: #16a34a;
            font-weight: bold;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙˆØ±Ù… */
        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.7rem 1.2rem;
            font-size: 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        .btn:hover { background: var(--secondary-color); }
        .btn-success {
            background: var(--success-color);
            width: 100%;
            font-size: 1.2rem;
            padding: 1rem;
        }
        .btn-success:hover { background: #0da271; }
        .btn-danger { background: var(--danger-color); font-size: 0.8rem; padding: 0.3rem 0.6rem; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-warning { background: var(--warning-color); color: #000; }
        .btn-warning:hover { background: #fca5a5; }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Ø¹Ù…ÙˆØ¯ÙŠÙ† Ù…ØªØ³Ø§ÙˆÙŠÙŠÙ† */
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .form-group { margin-bottom: 0.5rem; position: relative; }
        .form-group.full-width { grid-column: 1 / -1; }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 1rem;
            background: white;
            transition: var(--transition);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.2);
        }
        input:disabled { background-color: #f3f4f6; cursor: not-allowed; color: #555; }

        .radio-group { display: flex; flex-direction: column; gap: 0.8rem; margin-top: 0.5rem; padding: 0.8rem; background: var(--bg-light); border-radius: var(--radius-md); }
        .radio-option { display: flex; align-items: center; gap: 0.5rem; }
        .hidden { display: none; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ */
        .items-entry-section {
            grid-column: 1 / -1;
            border: 2px solid var(--primary-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            background: var(--bg-light);
        }
        .items-entry-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 2 Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
            gap: 1rem;
            align-items: flex-end;
        }
        .items-entry-grid-full {
             display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 Ø£Ø¹Ù…Ø¯Ø© */
            gap: 1rem;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ© */
        .items-table-container {
            grid-column: 1 / -1;
            margin-top: 1rem;
            width: 100%;
            overflow-x: auto; /* Ø¥Ø¶Ø§ÙØ© Ø³ÙƒØ±ÙˆÙ„ Ø£ÙÙ‚ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */
        }
        #itemsTable {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            min-width: 600px; /* Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø´Ø§Ø´Ø© ØµØºÙŠØ±Ø© */
        }
        #itemsTable th, #itemsTable td {
            border: 1px solid var(--border-color);
            padding: 0.8rem;
        }
        #itemsTable th {
            background-color: var(--secondary-color);
            color: white;
        }
        #itemsTable td { background: white; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© */
        .image-preview-container {
            display: block; 
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            padding: 1rem;
            min-height: 100px;
            border-radius: var(--radius-md);
            background: #fff;
        }
        .image-preview-item {
            position: relative;
            display: block; 
            margin-bottom: 1rem; 
            text-align: center; 
        }
        .image-preview-item img {
            max-width: 300px; 
            width: 90%; 
            height: auto; 
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
        }
        
        /* Ø²Ø± Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© */
        .delete-img-btn {
            position: absolute;
            top: 5px;
            right: 10px; 
            z-index: 10;
            padding: 2px 8px;
            font-size: 1rem;
            line-height: 1.2;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        .delete-img-btn:hover {
            background: #b91c1c;
        }


        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© */
        .suggestions-container {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 2px solid var(--primary-color);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 12px;
            font-size: 0.95rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: var(--bg-light); }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .form-grid {
                grid-template-columns: 1fr; /* Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            }
            
            .items-entry-grid {
                grid-template-columns: 1fr; /* Ø¬Ø¹Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù…ÙˆØ¯ÙŠØ© */
                gap: 0.8rem;
            }
            .items-entry-grid-full {
                grid-template-columns: 1fr; /* Ø¹Ù…ÙˆØ¯ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
                gap: 0.8rem;
            }

            .radio-group {
                flex-direction: column; /* ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ø¹Ù…ÙˆØ¯ÙŠ */
            }
            
            #itemsTable th, #itemsTable td {
                padding: 0.5rem;
                font-size: 0.85rem; /* ØªØµØºÙŠØ± Ø®Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
            }
        }
        
    </style>

    <style id="print-styles-template" type="text/template">
        body {
            font-family: 'Tahoma', sans-serif;
            color: #000;
            margin: 0;
            padding: 0;
            background: #fff;
            font-size: 11pt; /* Ø­Ø¬Ù… Ø®Ø· Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        }
        .voucher-container {
            width: 100%;
            margin: 0;
            padding: 0;
        }
        .header-container {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 3px double #000; /* Ø®Ø· Ù…Ø²Ø¯ÙˆØ¬ */
        }
        h1 {
            font-size: 16pt; /* Ø§Ø³ØªØ®Ø¯Ø§Ù… pt Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
            font-weight: bold;
            margin: 0;
        }
        h2 {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0;
        }
        .doc-info {
            display: flex;
            justify-content: space-between;
            padding: 15px 0 10px 0;
            font-size: 12pt;
            font-weight: bold;
        }
        .main-title {
            text-align:center;
            background: #e0e0e0;
            padding: 8px;
            font-size: 14pt;
            font-weight: bold;
            margin: 15px 0;
            border: 1px solid #000;
        }
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 11pt;
        }
        .info-table th, .info-table td {
            border: 1px solid #333;
            padding: 10px;
            text-align: right;
        }
        .info-table th {
            background-color: #f4f4f4;
            width: 130px;
            font-weight: bold;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11pt;
        }
        .items-table th, .items-table td {
            border: 2px solid #000; /* Ø­Ø¯ÙˆØ¯ Ø³Ù…ÙŠÙƒØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
            padding: 10px;
            text-align: center;
            word-wrap: break-word; /* Ù„ÙƒØ³Ø± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
        }
        .items-table th {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        .items-table td:nth-child(2) { /* Ø¹Ù…ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© */
             text-align: right;
             width: 40%;
        }
        .signatures {
            margin-top: 60px;
            padding-top: 20px;
            display: flex;
            justify-content: space-around;
            font-size: 12pt;
            font-weight: bold;
            page-break-inside: avoid; /* Ù…Ù†Ø¹ ÙƒØ³Ø± Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ */
        }
        .signatures div {
            text-align: center;
        }
        .signatures span {
            display: block;
            margin-top: 50px; /* Ù…Ø³Ø§ÙØ© ÙƒØ¨ÙŠØ±Ø© Ù„Ù„ØªÙˆÙ‚ÙŠØ¹ */
            padding-top: 5px;
            border-top: 1px dotted #000;
        }
        .notes-section, .attachments-section {
            margin-top: 25px;
            page-break-inside: avoid; /* Ù…Ù†Ø¹ ÙƒØ³Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        }
        .notes-section h3, .attachments-section h3 {
            font-size: 13pt;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .notes-section p {
            white-space: pre-wrap;
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 50px;
        }
        
        .attachments-section img {
            max-width: 100%;
            max-height: 80vh; /* ØªØµØºÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„ØµÙØ­Ø© */
            object-fit: contain;
            display: block;
            border: 1px solid #ccc;
            margin: 15px auto;
            page-break-inside: avoid; /* Ù…Ù†Ø¹ ØªÙ‚Ø·ÙŠØ¹ Ø§Ù„ØµÙˆØ±Ø© */
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { margin: 0; }
            .voucher-container { border: none; }
            .attachments-section {
                /* page-break-before: always; */ /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØ³Ø± Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ø£Ø¯Ø§Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙˆØµÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h1>
        </header>

        <div class="steps-container">
            <div class="step" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h2 class="step-title">ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ (CSV)</h2>
                </div>
                <div class="file-upload-container" id="dropZone">
                    <div class="file-upload-icon">ğŸ“</div>
                    <div class="file-upload-text">
                        <h3>Ø§Ø³Ø­Ø¨ Ù…Ù„Ù `SØ§Ù„Ù‚Ø§Ø¹Ø¯Ø©.csv` ÙˆØ£ÙÙ„ØªÙ‡ Ù‡Ù†Ø§</h3>
                        <p>Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</p>
                    </div>
                    <button type="button" class="file-upload-button" id="browseButton">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button>
                    <input type="file" id="csvFileInput" class="hidden-file-input" accept=".csv">
                    <div class="file-info" id="fileInfo"></div>
                </div>
                <button type="button" id="deleteDbBtn" class="btn btn-warning" style="width:100%; margin-top: 1rem;">
                    Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯
                </button>
            </div>

            <div class="step hidden" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h2 class="step-title">Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙ„</h2>
                </div>
                
                <form id="voucherForm">
                    <div class="form-grid">
                        
                        <div class="form-group">
                            <label for="institution">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ø§Ù„Ø¬Ù‡Ø©):</label>
                            <select id="institution" required>
                                <option value="">(Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¤Ø³Ø³Ø©)</option>
                                <option value="Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­Ø³ÙŠÙ†">Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­Ø³ÙŠÙ†</option>
                                <option value="Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù†Ø³Ø§Ø¦ÙŠØ©">Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù†Ø³Ø§Ø¦ÙŠØ©</option>
                                <option value="Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø®Ø¶Ø±">Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø®Ø¶Ø±</option>
                                <option value="Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø±Ù…ÙŠØ«Ø©">Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø±Ù…ÙŠØ«Ø©</option>
                                <option value="Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙˆØ±ÙƒØ§Ø¡">Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙˆØ±ÙƒØ§Ø¡</option>
                                <option value="Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ø¬Ø¯">Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ø¬Ø¯</option>
                                <option value="Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù‡Ù„Ø§Ù„">Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù‡Ù„Ø§Ù„</option>
                                <option value="Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø³Ù…Ø§ÙˆØ© Ø§Ù„Ø§ÙˆÙ„">Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø³Ù…Ø§ÙˆØ© Ø§Ù„Ø§ÙˆÙ„</option>
                                <option value="Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø³Ù…Ø§ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠ">Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø³Ù…Ø§ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                <option value="Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø±Ù…ÙŠØ«Ø©">Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø±Ù…ÙŠØ«Ø©</option>
                                <option value="Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø¶Ø±">Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø¶Ø±</option>
                                <option value="Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙˆØ±ÙƒØ§Ø¡">Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙˆØ±ÙƒØ§Ø¡</option>
                                <option value="Ù…Ø±ÙƒØ² Ø§Ù„ØªØ®ØµØµÙŠ Ù„Ù„Ø³ÙƒØ±ÙŠ">Ù…Ø±ÙƒØ² Ø§Ù„ØªØ®ØµØµÙŠ Ù„Ù„Ø³ÙƒØ±ÙŠ</option>
                                <option value="Ù…Ø±ÙƒØ² ØªØ£Ù‡ÙŠÙ„ Ø§Ù„Ù…Ø¹ÙˆÙ‚ÙŠÙ†">Ù…Ø±ÙƒØ² ØªØ£Ù‡ÙŠÙ„ Ø§Ù„Ù…Ø¹ÙˆÙ‚ÙŠÙ†</option>
                                <option value="Ù…Ø±ÙƒØ² Ø§Ù„ØµØ¯Ø±ÙŠØ©">Ù…Ø±ÙƒØ² Ø§Ù„ØµØ¯Ø±ÙŠØ©</option>
                                <option value="Ù…Ø±ÙƒØ² Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© ÙˆØ¬Ù„Ø¯ÙŠØ©">Ù…Ø±ÙƒØ² Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© ÙˆØ¬Ù„Ø¯ÙŠØ©</option>
                                <option value="Ø´Ø±ÙƒØ© ÙƒÙŠÙ…Ø§Ø¯ÙŠØ§ (Ø¬Ù‡Ø© Ù…Ø¬Ù‡Ø²Ø©)">Ø´Ø±ÙƒØ© ÙƒÙŠÙ…Ø§Ø¯ÙŠØ§ (Ø¬Ù‡Ø© Ù…Ø¬Ù‡Ø²Ø©)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="voucherNumber">Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <input type="text" id="voucherNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„ Ø¥Ù† ÙˆØ¬Ø¯...">
                        </div>

                        <div class="form-group full-width">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="outgoing" name="operationType" value="Ø¥Ø®Ø±Ø§Ø¬ Ù…Ø®Ø²Ù†ÙŠ" checked>
                                    <label for="outgoing">ØªØ¬Ù‡ÙŠØ² / Ø¥Ø®Ø±Ø§Ø¬ Ù…Ø®Ø²Ù†ÙŠ</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="incoming" name="operationType" value="Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²Ù†ÙŠ">
                                    <label for="incoming">Ø§Ø³ØªÙ„Ø§Ù… / Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²Ù†ÙŠ</label>
                                </div>
                            </div>
                        </div>

                        <fieldset class="items-entry-section">
                            <legend style="font-weight: bold; font-size: 1.1rem; color: var(--secondary-color); margin-right: 10px;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯</legend>
                            <div class="items-entry-grid">
                                <div class="form-group">
                                    <label for="itemMaterialName">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                                    <input type="text" id="itemMaterialName" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø§Ø¯Ø©..." autocomplete="off">
                                    <div id="custom-suggestions" class="suggestions-container"></div>
                                </div>
                                <div class="form-group">
                                    <label for="itemCategory">Ø§Ù„ÙØ¦Ø©:</label>
                                    <input type="text" id="itemCategory" disabled>
                                </div>
                            </div>
                            <div class="items-entry-grid-full">
                                <div class="form-group">
                                    <label for="itemQuantity">Ø§Ù„Ø¹Ø¯Ø¯:</label>
                                    <input type="number" id="itemQuantity" min="1">
                                </div>
                                <div class="form-group">
                                    <label for="itemWarehouse">Ø§Ù„Ù…Ø®Ø²Ù†:</label>
                                    <select id="itemWarehouse">
                                        <option value="Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
                                        <option value="Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„ÙØ±Ø¹ÙŠ Ø£">Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„ÙØ±Ø¹ÙŠ Ø£</option>
                                        <option value="Ù…Ø®Ø²Ù† Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø®Ø§ØµØ©">Ù…Ø®Ø²Ù† Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø®Ø§ØµØ©</option>
                                        <option value="Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª">Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª</option>
                                        <option value="ØºÙŠØ± Ù…Ø­Ø¯Ø¯">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
                                    </select>
                                </div>
                                <div class="form-group" style="align-self: center; padding-top: 1.5rem;">
                                    <input type="checkbox" id="itemIsPurchased" style="width: auto; margin-left: 5px;">
                                    <label for="itemIsPurchased" style="display: inline-block;">Ù…Ø´ØªØ±ÙŠØ§Øª</label>
                                </div>
                            </div>
                            <button type="button" id="addItemBtn" class="btn" style="margin-top: 1rem;">+ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ù„Ø¬Ø¯ÙˆÙ„</button>
                        </fieldset>
                        
                        <div class="items-table-container">
                            <label style="font-weight: bold; font-size: 1.1rem;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„ÙˆØµÙ„:</label>
                            <table id="itemsTable">
                                <thead>
                                    <tr>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th>Ø§Ù„ÙØ¦Ø©</th>
                                        <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                                        <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
                                        <th>Ø­Ø°Ù</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    </tbody>
                            </table>
                        </div>

                        <div class="form-group full-width">
                            <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <textarea id="notes" placeholder="Ø£Ø¯Ø®Ù„ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ØªØ´ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ÙØ§Ø°ØŒ Ø¥Ù„Ø®...)" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="documentImages">Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø©):</label>
                            <input type="file" id="documentImages" accept="image/*" multiple>
                            <div class="image-preview-container" id="imagePreviewContainer">
                                </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <button type="submit" class="btn btn-success" id="generateBtn">
                                Ø¥Ù†Ø´Ø§Ø¡ ÙˆØµÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø£Ùˆ Ø§Ù„Ø­ÙØ¸ ÙƒÙ€ PDF)
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <footer>
            <p>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„ØµÙŠØ¯Ù„Ø§Ù†ÙŠ Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†  Ø§Ù„Ù†Ø§Ø¬ÙŠ  Ù„Ù€: Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰ - Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© - Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†</p>
        </footer>
    </div>

    <script>
        // --- ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let materialsMap = new Map();
        let addedItems = [];
        let addedImageFilesBase64 = []; // *** ØªØ¹Ø¯ÙŠÙ„: Ù†Ø®Ø²Ù† Base64 Ù…Ø¨Ø§Ø´Ø±Ø© ***

        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const csvFileInput = document.getElementById('csvFileInput');
        const browseButton = document.getElementById('browseButton');
        const dropZone = document.getElementById('dropZone');
        const fileInfo = document.getElementById('fileInfo');
        const deleteDbBtn = document.getElementById('deleteDbBtn');
        const voucherForm = document.getElementById('voucherForm');
        
        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„ÙØ±Ø¹ÙŠ (Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©)
        const itemMaterialNameInput = document.getElementById('itemMaterialName');
        const itemCategoryInput = document.getElementById('itemCategory');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const itemWarehouseInput = document.getElementById('itemWarehouse');
        const itemIsPurchasedCheckbox = document.getElementById('itemIsPurchased');
        const addItemBtn = document.getElementById('addItemBtn');
        const itemsTableBody = document.getElementById('itemsTableBody');
        const suggestionsBox = document.getElementById('custom-suggestions');
        
        // Ø¹Ù†Ø§ØµØ± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
        const documentImagesInput = document.getElementById('documentImages');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        
        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const institutionSelect = document.getElementById('institution');
        const voucherNumberInput = document.getElementById('voucherNumber');
        const operationTypeRadios = document.getElementsByName('operationType');
        const notesTextarea = document.getElementById('notes');

        // --- Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø« ---
        document.addEventListener('DOMContentLoaded', () => {
            // ØªØ­Ù…ÙŠÙ„ CSV
            browseButton.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', handleFileSelect);
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);
            deleteDbBtn.addEventListener('click', deleteDatabase);
            
            // ÙÙˆØ±Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯
            itemMaterialNameInput.addEventListener('input', handleMaterialInput);
            itemIsPurchasedCheckbox.addEventListener('change', toggleWarehouseInput);
            addItemBtn.addEventListener('click', addItemToTable);
            itemsTableBody.addEventListener('click', handleTableClick); // Ù„Ø­Ø°Ù Ø§Ù„ØµÙÙˆÙ

            // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
            documentImagesInput.addEventListener('change', handleImageUpload);
            imagePreviewContainer.addEventListener('click', handleImageDelete);

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØµÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            voucherForm.addEventListener('submit', generateVoucher);

            // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
            document.addEventListener('click', (e) => {
                if (e.target.id !== 'itemMaterialName' && !suggestionsBox.contains(e.target)) {
                    suggestionsBox.style.display = 'none';
                }
            });
            
            // *** Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ***
            loadDatabaseFromStorage();
            loadFormStateFromStorage();
            renderItemsTable();
            renderImagePreviews();
        });

        // --- *** ÙˆØ¸Ø§Ø¦Ù Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ *** ---
        function saveDatabaseToStorage() {
            try {
                localStorage.setItem('materialsDatabase', JSON.stringify(Array.from(materialsMap.entries())));
            } catch (e) {
                console.error("ÙØ´Ù„ Ø­ÙØ¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e);
                alert("ÙØ´Ù„ Ø­ÙØ¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù…ØªÙ„Ø¦Ø©.");
            }
        }

        function loadDatabaseFromStorage() {
            const dbString = localStorage.getItem('materialsDatabase');
            if (dbString) {
                try {
                    materialsMap = new Map(JSON.parse(dbString));
                    fileInfo.textContent = `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© (${materialsMap.size} Ù…Ø§Ø¯Ø©).`;
                    step1.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·ÙˆØ© 1 Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø®ÙŠØ§Ø± Ø§Ù„Ø­Ø°Ù
                    step2.classList.remove('hidden');
                    deleteDbBtn.classList.remove('hidden');
                } catch (e) {
                    console.error("ÙØ´Ù„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e);
                    localStorage.removeItem('materialsDatabase'); // Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙØ©
                    step1.style.display = 'block';
                    step2.classList.add('hidden');
                }
            } else {
                step1.style.display = 'block';
                step2.classList.add('hidden');
                deleteDbBtn.classList.add('hidden'); // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ø­Ø°ÙÙ‡
            }
        }

        function deleteDatabase() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ Ø³ØªØ­ØªØ§Ø¬ Ù„Ø±ÙØ¹ Ù…Ù„Ù CSV Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")) {
                localStorage.removeItem('materialsDatabase');
                localStorage.removeItem('currentVoucher'); // Ø­Ø°Ù Ø§Ù„ÙˆØµÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø£ÙŠØ¶Ø§Ù‹
                alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
                location.reload();
            }
        }

        function saveFormState() {
            try {
                const operationType = document.querySelector('input[name="operationType"]:checked').value;
                const state = {
                    institution: institutionSelect.value,
                    voucherNumber: voucherNumberInput.value,
                    operationType: operationType,
                    notes: notesTextarea.value,
                    items: addedItems,
                    images: addedImageFilesBase64
                };
                localStorage.setItem('currentVoucher', JSON.stringify(state));
            } catch (e) {
                console.error("ÙØ´Ù„ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙˆØ±Ù…:", e);
                // Ù„Ø§ Ù†Ø±Ø³Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ø§ Ù†Ø²Ø¹Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ ÙƒÙ„ Ø¶ØºØ·Ø© Ø²Ø±
            }
        }

        function loadFormStateFromStorage() {
            const stateString = localStorage.getItem('currentVoucher');
            if (stateString) {
                try {
                    const state = JSON.parse(stateString);
                    institutionSelect.value = state.institution || '';
                    voucherNumberInput.value = state.voucherNumber || '';
                    notesTextarea.value = state.notes || '';
                    document.querySelector(`input[name="operationType"][value="${state.operationType}"]`).checked = true;
                    addedItems = state.items || [];
                    addedImageFilesBase64 = state.images || [];
                } catch (e) {
                    console.error("ÙØ´Ù„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙˆØ±Ù…:", e);
                    localStorage.removeItem('currentVoucher'); // Ø­Ø°Ù Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙØ©
                }
            }
        }
        
        function clearFormState() {
            localStorage.removeItem('currentVoucher');
            addedItems = [];
            addedImageFilesBase64 = [];
            institutionSelect.value = '';
            voucherNumberInput.value = '';
            notesTextarea.value = '';
            document.getElementById('outgoing').checked = true;
            renderItemsTable();
            renderImagePreviews();
        }

        // --- ÙˆØ¸Ø§Ø¦Ù ØªØ­Ù…ÙŠÙ„ CSV (Ù…Ø¹Ø¯Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©) ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) { processFile(file); }
        }
        function handleDragOver(event) {
            event.preventDefault();
            dropZone.classList.add('drag-over');
        }
        function handleDragLeave(event) {
            event.preventDefault();
            dropZone.classList.remove('drag-over');
        }
        function handleDrop(event) {
            event.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = event.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processFile(file);
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙÙ„Ø§Øª Ù…Ù„Ù CSV ØµØ§Ù„Ø­ ÙÙ‚Ø·.');
            }
        }
        
        function processFile(file) {
            fileInfo.textContent = `Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${file.name}...`;
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                try {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        encoding: "UTF-8",
                        complete: function(results) {
                            if (!results || !results.data || !results.meta || !results.meta.fields || !results.meta.fields.includes("Name")) {
                                 alert("Ø®Ø·Ø£: Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ 'Name'.");
                                 fileInfo.textContent = "ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                                 return;
                            }
                            
                            materialsMap.clear();
                            let count = 0;
                            results.data.forEach(row => {
                                if (row.Name && row.Name.trim() !== "") {
                                    const name = row.Name.trim();
                                    const category = row.Category ? row.Category.trim() : "ØºÙŠØ± Ù…ØµÙ†Ù";
                                    materialsMap.set(name, category);
                                    count++;
                                }
                            });
                            
                            saveDatabaseToStorage(); // *** Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ***
                            
                            fileInfo.textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙˆØ­ÙØ¸ ${count} Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!`;
                            fileInfo.style.color = 'var(--success-color)';
                            
                            step1.style.display = 'block'; // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ© 1 Ø¸Ø§Ù‡Ø±Ø©
                            deleteDbBtn.classList.remove('hidden');
                            step2.classList.remove('hidden');
                        },
                        error: (error) => {
                            console.error('Ø®Ø·Ø£ ÙÙŠ PapaParse:', error);
                            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                        }
                    });
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ PapaParse:', error);
                    alert(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙØ§Ø¯Ø­ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„:\n\n${error.message}`);
                }
            };
            reader.onerror = () => {
                 console.error("Ø®Ø·Ø£ ÙÙŠ FileReader:", reader.error);
                 alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ø³Ù…Ø­Øª Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙØ§Øª.");
            };
            reader.readAsText(file, "UTF-8");
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ù…Ø®ØµØµØ© ---
        function handleMaterialInput(event) {
            const currentName = event.target.value;
            updateCategory(currentName);
            showSuggestions(currentName);
        }
        function updateCategory(name) {
            const materialName = name.trim();
            itemCategoryInput.value = materialsMap.get(materialName) || '';
        }
        function showSuggestions(inputText) {
            suggestionsBox.innerHTML = '';
            if (inputText.length === 0) {
                suggestionsBox.style.display = 'none';
                return;
            }
            const allNames = Array.from(materialsMap.keys());
            const matchingSuggestions = allNames.filter(name => 
                name.toLowerCase().includes(inputText.toLowerCase())
            ).slice(0, 7);
            
            if (matchingSuggestions.length === 0) {
                suggestionsBox.style.display = 'none';
                return;
            }
            
            matchingSuggestions.forEach(name => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = name;
                item.addEventListener('click', () => {
                    itemMaterialNameInput.value = name;
                    suggestionsBox.style.display = 'none';
                    updateCategory(name);
                });
                suggestionsBox.appendChild(item);
            });
            suggestionsBox.style.display = 'block';
        }

        // --- ÙˆØ¸ÙŠÙØ© ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²Ù† ---
        function toggleWarehouseInput() {
            if (itemIsPurchasedCheckbox.checked) {
                itemWarehouseInput.disabled = true;
                itemWarehouseInput.value = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; // Ø£Ùˆ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            } else {
                itemWarehouseInput.disabled = false;
            }
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ---
        function addItemToTable() {
            const name = itemMaterialNameInput.value.trim();
            const category = itemCategoryInput.value.trim();
            const quantity = parseInt(itemQuantityInput.value);
            const isPurchased = itemIsPurchasedCheckbox.checked;
            const warehouse = isPurchased ? "Ù…Ø´ØªØ±ÙŠØ§Øª" : itemWarehouseInput.value;

            if (!materialsMap.has(name)) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ (ÙƒÙ…ÙŠØ©) ØµØ§Ù„Ø­Ø©.");
                return;
            }

            addedItems.push({ name, category, quantity, warehouse, isPurchased });
            renderItemsTable();
            saveFormState(); // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙÙˆØ±Ù…
            itemMaterialNameInput.value = '';
            itemCategoryInput.value = '';
            itemQuantityInput.value = '';
            itemIsPurchasedCheckbox.checked = false;
            itemWarehouseInput.disabled = false;
        }

        function renderItemsTable() {
            itemsTableBody.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (addedItems.length === 0) {
                 itemsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 10px;">Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…ÙˆØ§Ø¯ Ø¨Ø¹Ø¯.</td></tr>';
                 return;
            }
            
            addedItems.forEach((item, index) => {
                const row = document.createElement('tr');
                const warehouseCell = `<td style="${item.isPurchased ? 'background-color: #fef9c3; font-weight: bold;' : ''}">${item.warehouse}</td>`;
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.quantity}</td>
                    ${warehouseCell}
                    <td>
                        <button type="button" class="btn btn-danger delete-item-btn" data-index="${index}">
                            &times;
                        </button>
                    </td>
                `;
                itemsTableBody.appendChild(row);
            });
        }
        
        function handleTableClick(event) {
            if (event.target.classList.contains('delete-item-btn')) {
                const index = parseInt(event.target.getAttribute('data-index'));
                addedItems.splice(index, 1);
                renderItemsTable();
                saveFormState(); // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
            }
        }
        
        // --- ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ± (ØªØ³ØªØ®Ø¯Ù… Base64) ---
        function handleImageUpload(event) {
            const newFiles = Array.from(event.target.files);
            
            newFiles.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageBase64 = e.target.result;
                        addedImageFilesBase64.push(imageBase64); // ØªØ®Ø²ÙŠÙ† Base64
                        renderImagePreviews();
                        saveFormState(); // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
                    };
                    reader.readAsDataURL(file);
                }
            });
            documentImagesInput.value = null; // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚Ù„
        }

        function renderImagePreviews() {
            imagePreviewContainer.innerHTML = '';
            addedImageFilesBase64.forEach((imageBase64, index) => {
                const img = document.createElement('img');
                img.src = imageBase64;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'btn btn-danger delete-img-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.setAttribute('data-index', index);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'image-preview-item';
                itemDiv.appendChild(deleteBtn);
                itemDiv.appendChild(img);
                
                imagePreviewContainer.appendChild(itemDiv);
            });
        }
        
        function handleImageDelete(event) {
            if (event.target.classList.contains('delete-img-btn')) {
                const index = parseInt(event.target.getAttribute('data-index'));
                addedImageFilesBase64.splice(index, 1); // Ø­Ø°Ù Base64
                renderImagePreviews();
                saveFormState(); // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
            }
        }
        
        // --- ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ---
        function generateFilename(institution, items) {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const today = `${year}-${month}-${day}`;

            const instName = institution.replace(/ /g, '_');
            const uniqueWarehouses = [...new Set(items.map(item => item.warehouse.replace(/ /g, '_')))].join('-');
            
            return `ØªØ¬Ù‡ÙŠØ²-${instName}-${uniqueWarehouses}-${today}`;
        }
        
        // --- ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØµÙ„ ---
        async function generateVoucher(event) {
            event.preventDefault(); 

            if (institutionSelect.value === "") {
                 alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ø§Ù„Ø¬Ù‡Ø©).");
                 return;
            }
            if (addedItems.length === 0) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØµÙ„.");
                return;
            }

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert("ÙØ´Ù„ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Popups).");
                return;
            }
            printWindow.document.write('<html><head><title>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</title></head><body><h1>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙˆØµÙ„...</h1></body></html>');

            try {
                const formData = {
                    operationType: document.querySelector('input[name="operationType"]:checked').value,
                    institution: institutionSelect.value,
                    voucherNumber: voucherNumberInput.value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                    notes: notesTextarea.value.trim(),
                    currentDate: new Date().toLocaleString('ar-IQ', { dateStyle: 'full', timeStyle: 'short' })
                };
                
                const instLabel = (formData.operationType === 'Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²Ù†ÙŠ') ? 'Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¬Ù‡Ø²Ø©' : 'Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©';
                const imagesBase64 = addedImageFilesBase64;
                const dynamicFilename = generateFilename(formData.institution, addedItems);
                
                // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                openPrintWindow(printWindow, formData, instLabel, addedItems, imagesBase64, dynamicFilename);
                
                // Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                clearFormState();

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ generateVoucher:", error);
                alert(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙØ§Ø¯Ø­:\n\n${error.message}`);
                printWindow.close();
            }
        }
        
        // --- ÙˆØ¸ÙŠÙØ© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ---
        function openPrintWindow(printWindow, data, instLabel, items, imagesBase64, dynamicFilename) {
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… CSS Ø§Ù„Ù…ÙØµÙˆÙ„
                const printStyles = document.getElementById('print-styles-template').innerHTML;
                
                // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯
                let itemsTableHtml = '';
                items.forEach((item, index) => {
                    const warehouseCell = `<td style="${item.isPurchased ? 'background-color: #fef9c3; font-weight: bold;' : ''}">${item.warehouse}</td>`;
                    
                    itemsTableHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>${item.category}</td>
                            <td>${item.quantity}</td>
                            ${warehouseCell}
                        </tr>
                    `;
                });
                
                // Ø¨Ù†Ø§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                let attachmentsHtml = '';
                if (imagesBase64.length > 0) {
                    attachmentsHtml = '<div class="attachments-section"><h3>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:</h3>';
                    imagesBase64.forEach(imgSrc => {
                        attachmentsHtml += `<img src="${imgSrc}" alt="Ù…Ø±ÙÙ‚">`;
                    });
                    attachmentsHtml += '</div>';
                }
                
                // Ø¨Ù†Ø§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                let notesHtml = '';
                if (data.notes) {
                    notesHtml = `
                        <div class="notes-section">
                            <h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h3>
                            <p>${data.notes}</p>
                        </div>
                    `;
                }

                // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                let htmlContent = `
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>${dynamicFilename}</title>
                        <style>${printStyles}</style>
                    </head>
                    <body>
                        <div class="voucher-container">
                            <div class="header-container">
                                <h1>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©</h1>
                                <h2> Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰ / Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„Ø© </h2>
                            </div>
                            
                            <div class="doc-info">
                                <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${data.currentDate}</span>
                                <span>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„: ${data.voucherNumber}</span>
                            </div>
                            
                            <h2 class="main-title">ÙˆØµÙ„ ${data.operationType}</h2>
                            
                            <table class="info-table">
                                <tr>
                                    <th>${instLabel}</th>
                                    <td>${data.institution}</td>
                                </tr>
                            </table>

                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Øª</th>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th>Ø§Ù„ÙØ¦Ø©</th>
                                        <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                                        <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsTableHtml}
                                </tbody>
                            </table>
                            
                            ${notesHtml}
                            ${attachmentsHtml}

                            <div class="signatures">
                                <div>Ø§Ù„Ù…Ù†Ø¸Ù…<span>..............................</span></div>
                                <div>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨<span>..............................</span></div>
                                <div>Ø§Ù„Ù…Ø¯ÙŠØ±<span>..............................</span></div>
                                <div>Ø§Ù„Ù…Ø³ØªÙ„Ù…<span>..............................</span></div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
                
                printWindow.document.open();
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                }, 1000); // 1 Ø«Ø§Ù†ÙŠØ©
            
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ openPrintWindow:", error);
                alert(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¶ÙŠØ± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:\n\n${error.message}`);
            }
        }
    </script>
</body>
</html>
